
var mpath = require('./')
var Bench = require('benchmark');
var sha = require('child_process').exec("git log --pretty=format:'%h' -n 1", function (err, sha) {
  if (err) return next(err);

  var fs = require('fs')
  var filename = __dirname + '/bench.out';
  var out = fs.createWriteStream(filename, { flags: 'a', encoding: 'utf8' });

  /**
   * test doc creator
   */

  function doc () {
    var o = { first: { second: { third: [3,{ name: 'aaron' }, 9] }}};
    o.reviews = [
        { name: 'one' }
      , { name: 'two', _doc: { name: '2' }}
      , { name: 'three'
          , reviews: [{},{ reviews: [{val: 'twoo'}]}]
          , _doc: { name: '3', reviews: [{},{ _doc: { reviews: [{ val: 2 }] }}]  }}
    ];
    o.name = 'jiro';
    o.array = [
        { o: { array: [{x: {b: [4,6,8]}}, { y: 10} ] }}
      , { o: { array: [{x: {b: [1,2,3]}}, { x: {z: 10 }}, { x: {b: 'hi'}}] }}
      , { o: { array: [{x: {b: null }}, { x: { b: [null, 1]}}] }}
      , { o: { array: [{x: null }] }}
      , { o: { array: [{y: 3 }] }}
      , { o: { array: [3, 0, null] }}
      , { o: { name: 'ha' }}
    ];
    o.arr = [
        { arr: [{ a: { b: 47 }}, { a: { c: 48 }}, { d: 'yep' }] }
      , { yep: true }
    ]
    return o;
  }

  var o = doc();

  var s = new Bench.Suite;
  s.add('mpath.get("first", obj)', function () {
    mpath.get('first', o);
  })
  s.add('mpath.get("first.second", obj)', function () {
    mpath.get('first.second', o);
  })
  s.add('mpath.get("first.second.third.1.name", obj)', function () {
    mpath.get('first.second.third.1.name', o);
  })
  s.add('mpath.get("reviews", obj)', function () {
    mpath.get('reviews', o);
  })
  s.add('mpath.get("reviews.1", obj)', function () {
    mpath.get('reviews.1', o);
  })
  s.add('mpath.get("reviews.2.name", obj)', function () {
    mpath.get('reviews.2.name', o);
  })
  s.add('mpath.get("reviews.2.reviews.1.reviews.0.val", obj)', function () {
    mpath.get('reviews.2.reviews.1.reviews.0.val', o);
  })
  s.add('mpath.get("reviews.name", obj)', function () {
    mpath.get('reviews.name', o);
  })

  s.add('mpath.set("first", obj, val)', function () {
    mpath.set('first', o, 1);
  })
  s.add('mpath.set("first.second", obj, val)', function () {
    mpath.set('first.second', o, 1);
  })
  s.add('mpath.set("first.second.third.1.name", obj, val)', function () {
    mpath.set('first.second.third.1.name', o, 1);
  })
  s.add('mpath.set("reviews", obj, val)', function () {
    mpath.set('reviews', o, 1);
  })
  s.add('mpath.set("reviews.1", obj, val)', function () {
    mpath.set('reviews.1', o, 1);
  })
  s.add('mpath.set("reviews.2.name", obj, val)', function () {
    mpath.set('reviews.2.name', o, 1);
  })
  s.add('mpath.set("reviews.2.reviews.1.reviews.0.val", obj, val)', function () {
    mpath.set('reviews.2.reviews.1.reviews.0.val', o, 1);
  })
  s.add('mpath.set("reviews.name", obj, val)', function () {
    mpath.set('reviews.name', o, 1);
  })

  s.on('start', function () {
    console.log('starting...');
    out.write('*' + sha + ': ' + String(new Date()) + '\n');
  });
  s.on('cycle', function (e) {
    var s = String(e.target);
    console.log(s);
    out.write(s + '\n');
  })
  s.on('complete', function () {
    console.log('done')
    out.end('');
  })
  s.run()
})

